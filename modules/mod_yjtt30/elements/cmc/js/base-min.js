function method(b,a){return function(){b[a].apply(b,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(a,c){if(a.next){try{while(true){c(a.next())}}catch(d){if(d!=StopIteration){throw d}}}else{for(var b=0;b<a.length;b++){c(a[b])}}}function map(a,c){var b=[];forEach(a,function(d){b.push(c(d))});return b}function matcher(a){return function(b){return a.test(b)}}function hasClass(b,c){var a=b.className;return a&&new RegExp("(^| )"+c+"($| )").test(a)}function insertAfter(a,c){var b=c.parentNode;b.insertBefore(a,c.nextSibling);return a}function removeElement(a){if(a.parentNode){a.parentNode.removeChild(a)}}function clearElement(a){while(a.firstChild){a.removeChild(a.firstChild)}}function isAncestor(a,b){while(b=b.parentNode){if(a==b){return true}}return false}var nbsp="\u00a0";var matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};function normalizeEvent(a){if(!a.stopPropagation){a.stopPropagation=function(){this.cancelBubble=true};a.preventDefault=function(){this.returnValue=false}}if(!a.stop){a.stop=function(){this.stopPropagation();this.preventDefault()}}if(a.type=="keypress"){a.code=(a.charCode==null)?a.keyCode:a.charCode;a.character=String.fromCharCode(a.code)}return a}function addEventHandler(c,b,a,e){function d(f){a(normalizeEvent(f||window.event))}if(typeof c.addEventListener=="function"){c.addEventListener(b,d,false);if(e){return function(){c.removeEventListener(b,d,false)}}}else{c.attachEvent("on"+b,d);if(e){return function(){c.detachEvent("on"+b,d)}}}}function nodeText(a){return a.textContent||a.innerText||a.nodeValue||""}function nodeTop(a){var b=0;while(a.offsetParent){b+=a.offsetTop;a=a.offsetParent}return b}function isBR(a){var b=a.nodeName;return b=="BR"||b=="br"}function isSpan(a){var b=a.nodeName;return b=="SPAN"||b=="span"}function History(b,e,a,d){this.container=b;this.maxDepth=e;this.commitDelay=a;this.editor=d;this.parent=d.parent;var c={text:"",from:null,to:null};this.first=c;this.last=c;this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}History.prototype={scheduleCommit:function(){var a=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){a.tryCommit()},this.commitDelay)},touch:function(a){this.setTouched(a);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var a=this.history.pop();this.redoHistory.push(this.updateTo(a,"applyChain"));this.notifyEnvironment();return this.chainNode(a)}},redo:function(){this.commit();if(this.redoHistory.length){var a=this.redoHistory.pop();this.addUndoLevel(this.updateTo(a,"applyChain"));this.notifyEnvironment();return this.chainNode(a)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(f,e,b){var d=[];for(var c=0;c<b.length;c++){var a=(c==b.length-1)?e:this.container.ownerDocument.createElement("BR");d.push({from:f,to:a,text:cleanText(b[c])});f=a}this.pushChains([d],f==null&&e==null);this.notifyEnvironment()},pushChains:function(b,a){this.commit(a);this.addUndoLevel(this.updateTo(b,"applyChain"));this.redoHistory=[]},chainNode:function(c){for(var a=0;a<c.length;a++){var d=c[a][0],b=d&&(d.from||d.to);if(b){return b}}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(a){return this.after(a).text},nodeAfter:function(a){return this.after(a).to},nodeBefore:function(a){return this.before(a).from},tryCommit:function(){if(!window.History){return}if(this.editor.highlightDirty()){this.commit(true)}else{this.scheduleCommit()}},commit:function(b){this.parent.clearTimeout(this.commitTimeout);if(!b){this.editor.highlightDirty(true)}var c=this.touchedChains(),a=this;if(c.length){this.addUndoLevel(this.updateTo(c,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(e,a){var d=[],c=[];for(var b=0;b<e.length;b++){d.push(this.shadowChain(e[b]));c.push(this[a](e[b]))}if(a=="applyChain"){this.notifyDirty(c)}return d},notifyDirty:function(a){forEach(a,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){if(window.frameElement&&window.frameElement.CodeMirror.updateNumbers){window.frameElement.CodeMirror.updateNumbers()}if(this.onChange){this.onChange()}},linkChain:function(c){for(var b=0;b<c.length;b++){var a=c[b];if(a.from){a.from.historyAfter=a}else{this.first=a}if(a.to){a.to.historyBefore=a}else{this.last=a}}},after:function(a){return a?a.historyAfter:this.first},before:function(a){return a?a.historyBefore:this.last},setTouched:function(a){if(a){if(!a.historyTouched){this.touched.push(a);a.historyTouched=true}}else{this.firstTouched=true}},addUndoLevel:function(a){this.history.push(a);if(this.history.length>this.maxDepth){this.history.shift()}},touchedChains:function(){var c=this;var d=null;function b(i){return i?i.historyTemp:d}function f(j,i){if(j){j.historyTemp=i}else{d=i}}function e(i){var k=[];for(var j=i?i.nextSibling:c.container.firstChild;j&&!isBR(j);j=j.nextSibling){if(j.currentText){k.push(j.currentText)}}return{from:i,to:j,text:cleanText(k.join(""))}}var a=[];if(c.firstTouched){c.touched.push(null)}forEach(c.touched,function(j){if(j&&j.parentNode!=c.container){return}if(j){j.historyTouched=false}else{c.firstTouched=false}var i=e(j),k=c.after(j);if(!k||k.text!=i.text||k.to!=i.to){a.push(i);f(j,i)}});function h(l,i){var k=i+"Sibling",j=l[k];while(j&&!isBR(j)){j=j[k]}return j}var g=[];c.touched=[];forEach(a,function(j){if(!b(j.from)){return}var k=[],l=j.from,m=true;while(true){var i=b(l);if(!i){if(m){break}else{i=e(l)}}k.unshift(i);f(l,null);if(!l){break}m=c.after(l);l=h(l,"previous")}l=j.to;m=c.before(j.from);while(true){if(!l){break}var i=b(l);if(!i){if(m){break}else{i=e(l)}}k.push(i);f(l,null);m=c.before(l);l=h(l,"next")}g.push(k)});return g},shadowChain:function(c){var e=[],d=this.after(c[0].from),b=c[c.length-1].to;while(true){e.push(d);var a=d.to;if(!a||a==b){break}else{d=a.historyAfter||this.before(b)}}return e},applyChain:function(a){var k=select.cursorPos(this.container,false),l=this;function b(p,o){var n=p?p.nextSibling:l.container.firstChild;while(n!=o){var i=n.nextSibling;removeElement(n);n=i}}var c=a[0].from,g=a[a.length-1].to;b(c,g);for(var h=0;h<a.length;h++){var m=a[h];if(h>0){l.container.insertBefore(m.from,g)}var d=makePartSpan(fixSpaces(m.text),this.container.ownerDocument);l.container.insertBefore(d,g);if(k&&k.node==m.from){var f=0;var e=this.after(m.from);if(e&&h==a.length-1){for(var j=0;j<k.offset&&m.text.charAt(j)==e.text.charAt(j);j++){}if(k.offset>j){f=m.text.length-e.text.length}}select.setCursorPos(this.container,{node:m.from,offset:Math.max(0,k.offset+f)})}else{if(k&&(h==a.length-1)&&k.node&&k.node.parentNode!=this.container){select.setCursorPos(this.container,{node:m.from,offset:m.text.length})}}}this.linkChain(a);return c}};function tokenizer(d,c){function b(e){return e!="\n"&&/^[\s\u00a0]*$/.test(e)}var a={state:c,take:function(e){if(typeof(e)=="string"){e={style:e,type:e}}e.content=(e.content||"")+d.get();if(!/\n$/.test(e.content)){d.nextWhile(b)}e.value=e.content+d.get();return e},next:function(){if(!d.more()){throw StopIteration}var e;if(d.equals("\n")){d.next();return this.take("whitespace")}if(d.applies(b)){e="whitespace"}else{while(!e){e=this.state(d,function(f){a.state=f})}}return this.take(e)}};return a}var select={};(function(){select.ie_selection=document.selection&&document.selection.createRangeCollection;function e(j,k){while(j&&j.parentNode!=k){j=j.parentNode}return j}function i(j,k){while(!j.previousSibling&&j.parentNode!=k){j=j.parentNode}return e(j.previousSibling,k)}var f="\u00a0\u00a0\u00a0\u00a0";select.scrollToNode=function(m){if(!m){return}var z=m.ownerDocument,p=z.body,q=(z.defaultView||z.parentWindow),o=z.documentElement,r=!m.nextSibling||!m.nextSibling.nextSibling||!m.nextSibling.nextSibling.nextSibling;var w=0;while(m&&!m.offsetTop){w++;m=m.previousSibling}if(w==0){r=false}var t=w*(m?m.offsetHeight:0),v=0,s=m;while(s&&s.offsetParent){t+=s.offsetTop;if(!isBR(s)){v+=s.offsetLeft}s=s.offsetParent}var k=p.scrollLeft||o.scrollLeft||0,j=p.scrollTop||o.scrollTop||0,n=v-k,l=t-j,u=false;if(n<0||n>(q.innerWidth||o.clientWidth||0)){k=v;u=true}if(l<0||r||l>(q.innerHeight||o.clientHeight||0)-50){j=r?1000000:t;u=true}if(u){q.scrollTo(k,j)}};select.scrollToCursor=function(j){select.scrollToNode(select.selectionTopNode(j,true)||j.firstChild)};var c=null;select.snapshotChanged=function(){if(c){c.changed=true}};select.snapshotReplaceNode=function(n,m,k,l){if(!c){return}function j(o){if(n==o.node){c.changed=true;if(k&&o.offset>k){o.offset-=k}else{o.node=m;o.offset+=(l||0)}}}j(c.start);j(c.end)};select.snapshotMove=function(o,n,m,k,l){if(!c){return}function j(p){if(o==p.node&&(!l||p.offset==0)){c.changed=true;p.node=n;if(k){p.offset=Math.max(0,p.offset+m)}else{p.offset=m}}}j(c.start);j(c.end)};if(select.ie_selection){function g(n,j){var m=n.document.selection.createRange();m.collapse(j);function o(t){var u=null;while(!u&&t){u=t.nextSibling;t=t.parentNode}return l(u)}function l(t){while(t&&t.firstChild){t=t.firstChild}return{node:t,offset:0}}var s=m.parentElement();if(!isAncestor(n.document.body,s)){return null}if(!s.firstChild){return l(s)}var p=m.duplicate();p.moveToElementText(s);p.collapse(true);for(var q=s.firstChild;q;q=q.nextSibling){if(q.nodeType==3){var r=q.nodeValue.length;p.move("character",r)}else{p.moveToElementText(q);p.collapse(false)}var k=m.compareEndPoints("StartToStart",p);if(k==0){return o(q)}if(k==1){continue}if(q.nodeType!=3){return l(q)}p.setEndPoint("StartToEnd",m);return{node:q,offset:r-p.text.length}}return o(s)}select.markSelection=function(l){c=null;var k=l.document.selection;if(!k){return}var m=g(l,true),j=g(l,false);if(!m||!j){return}c={start:m,end:j,window:l,changed:false}};select.selectMarked=function(){if(!c||!c.changed){return}var m=c.window,l=m.document;function k(o){var p=l.body.createTextRange(),q=o.node;if(!q){p.moveToElementText(c.window.document.body);p.collapse(false)}else{if(q.nodeType==3){p.moveToElementText(q.parentNode);var r=o.offset;while(q.previousSibling){q=q.previousSibling;r+=(q.innerText||"").length}p.move("character",r)}else{p.moveToElementText(q);p.collapse(true)}}return p}var n=k(c.start),j=k(c.end);n.setEndPoint("StartToEnd",j);n.select()};select.selectionTopNode=function(j,k){var q=j.ownerDocument.selection;if(!q){return false}var o=q.createRange(),r=o.duplicate();o.collapse(k);var p=o.parentElement();if(p&&isAncestor(j,p)){r.moveToElementText(p);if(o.compareEndPoints("StartToStart",r)==1){return e(p,j)}}function m(t,v){if(v.nodeType==3){var u=0,x=v.previousSibling;while(x&&x.nodeType==3){u+=x.nodeValue.length;x=x.previousSibling}if(x){try{t.moveToElementText(x)}catch(w){return false}t.collapse(false)}else{t.moveToElementText(v.parentNode)}if(u){t.move("character",u)}}else{try{t.moveToElementText(v)}catch(w){return false}}return true}var k=0,n=j.childNodes.length-1;while(k<n){var s=Math.ceil((n+k)/2),l=j.childNodes[s];if(!l){return false}if(!m(r,l)){return false}if(o.compareEndPoints("StartToStart",r)==1){k=s}else{n=s-1}}return j.childNodes[k]||null};select.focusAfterNode=function(l,j){var k=j.ownerDocument.body.createTextRange();k.moveToElementText(l||j);k.collapse(!l);k.select()};select.somethingSelected=function(k){var j=k.document.selection;return j&&(j.createRange().text!="")};function a(m,k){var l=m.document.selection;if(l){var j=l.createRange();j.pasteHTML(k);j.collapse(false);j.select()}}select.insertNewlineAtCursor=function(j){a(j,"<br>")};select.insertTabAtCursor=function(j){a(j,f)};select.cursorPos=function(k,p){var n=k.ownerDocument.selection;if(!n){return null}var m=select.selectionTopNode(k,p);while(m&&!isBR(m)){m=m.previousSibling}var l=n.createRange(),j=l.duplicate();l.collapse(p);if(m){j.moveToElementText(m);j.collapse(false)}else{try{j.moveToElementText(k)}catch(o){return null}j.collapse(true)}l.setEndPoint("StartToStart",j);return{node:m,offset:l.text.length}};select.setCursorPos=function(k,n,m){function j(p){var o=k.ownerDocument.body.createTextRange();if(!p.node){o.moveToElementText(k);o.collapse(true)}else{o.moveToElementText(p.node);o.collapse(false)}o.move("character",p.offset);return o}var l=j(n);if(m&&m!=n){l.setEndPoint("EndToEnd",j(m))}l.select()};select.getBookmark=function(j){var l=select.cursorPos(j,true),k=select.cursorPos(j,false);if(l&&k){return{from:l,to:k}}};select.setBookmark=function(j,k){if(!k){return}select.setCursorPos(j,k.from,k.to)}}else{select.markSelection=function(m){var l=m.getSelection();if(!l||l.rangeCount==0){return(c=null)}var k=l.getRangeAt(0);c={start:{node:k.startContainer,offset:k.startOffset},end:{node:k.endContainer,offset:k.endOffset},window:m,changed:false};function j(n){while(n.node.nodeType!=3&&!isBR(n.node)){var o=n.node.childNodes[n.offset]||n.node.nextSibling;n.offset=0;while(!o&&n.node.parentNode){n.node=n.node.parentNode;o=n.node.nextSibling}n.node=o;if(!o){break}}}j(c.start);j(c.end)};select.selectMarked=function(){var l=c;function n(){return l.start.node==l.end.node&&l.start.offset==0&&l.end.offset==0}if(!l||!(l.changed||(webkit&&n()))){return}var m=l.window,k=m.document.createRange();function j(o,p){if(o.node){if(o.offset==0){k["set"+p+"Before"](o.node)}else{k["set"+p](o.node,o.offset)}}else{k.setStartAfter(m.document.body.lastChild||m.document.body)}}j(l.end,"End");j(l.start,"Start");h(k,m)};function h(j,l){var k=l.getSelection();k.removeAllRanges();k.addRange(j)}function b(k){var j=k.getSelection();if(!j||j.rangeCount==0){return false}else{return j.getRangeAt(0)}}select.selectionTopNode=function(j,n){var k=b(j.ownerDocument.defaultView);if(!k){return false}var l=n?k.startContainer:k.endContainer;var m=n?k.startOffset:k.endOffset;if(window.opera&&!n&&k.endContainer==j&&k.endOffset==k.startOffset+1&&j.childNodes[k.startOffset]&&isBR(j.childNodes[k.startOffset])){m--}if(l.nodeType==3){if(m>0){return e(l,j)}else{return i(l,j)}}else{if(l.nodeName.toUpperCase()=="HTML"){return(m==1?null:j.lastChild)}else{if(l==j){return(m==0)?null:l.childNodes[m-1]}else{if(m==l.childNodes.length){return e(l,j)}else{if(m==0){return i(l,j)}else{return e(l.childNodes[m-1],j)}}}}}};select.focusAfterNode=function(l,j){var m=j.ownerDocument.defaultView,k=m.document.createRange();k.setStartBefore(j.firstChild||j);if(l&&!l.firstChild){k.setEndAfter(l)}else{if(l){k.setEnd(l,l.childNodes.length)}else{k.setEndBefore(j.firstChild||j)}}k.collapse(false);h(k,m)};select.somethingSelected=function(k){var j=b(k);return j&&!j.collapsed};function d(l,k){var j=b(l);if(!j){return}j.deleteContents();j.insertNode(k);webkitLastLineHack(l.document.body);j=l.document.createRange();j.selectNode(k);j.collapse(false);h(j,l)}select.insertNewlineAtCursor=function(j){d(j,j.document.createElement("BR"))};select.insertTabAtCursor=function(j){d(j,j.document.createTextNode(f))};select.cursorPos=function(j,m){var k=b(window);if(!k){return}var l=select.selectionTopNode(j,m);while(l&&!isBR(l)){l=l.previousSibling}k=k.cloneRange();k.collapse(m);if(l){k.setStartAfter(l)}else{k.setStartBefore(j)}return{node:l,offset:k.toString().length}};select.setCursorPos=function(j,o,n){var m=j.ownerDocument.defaultView,l=m.document.createRange();function k(s,v,q){if(v==0&&s&&!s.nextSibling){l["set"+q+"After"](s);return true}if(!s){s=j.firstChild}else{s=s.nextSibling}if(!s){return}if(v==0){l["set"+q+"Before"](s);return true}var t=[];function p(w){if(w.nodeType==3){t.push(w)}else{forEach(w.childNodes,p)}}while(true){while(s&&!t.length){p(s);s=s.nextSibling}var u=t.shift();if(!u){return false}var r=u.nodeValue.length;if(r>=v){l["set"+q](u,v);return true}v-=r}}n=n||o;if(k(n.node,n.offset,"End")&&k(o.node,o.offset,"Start")){h(l,m)}}}})();var stringStream=function(c){var d="";var e=0;var b="";function a(){while(e==d.length){b+=d;d="";e=0;try{d=c.next()}catch(f){if(f!=StopIteration){throw f}else{return false}}}return true}return{peek:function(){if(!a()){return null}return d.charAt(e)},next:function(){if(!a()){if(b.length>0){throw"End of stringstream reached without emptying buffer ('"+b+"')."}else{throw StopIteration}}return d.charAt(e++)},get:function(){var f=b;b="";if(e>0){f+=d.slice(0,e);d=d.slice(e);e=0}return f},push:function(f){d=d.slice(0,e)+f+d.slice(e)},lookAhead:function(m,h,i,j){function l(q){return j?q.toLowerCase():q}m=l(m);var p=false;var o=b,n=e;if(i){this.nextWhileMatches(/[\s\u00a0]/)}while(true){var g=e+m.length,f=d.length-e;if(g<=d.length){p=m==l(d.slice(e,g));e=g;break}else{if(m.slice(0,f)==l(d.slice(e))){b+=d;d="";try{d=c.next()}catch(k){break}e=0;m=m.slice(f)}else{break}}}if(!(p&&h)){d=b.slice(o.length)+d;e=n;b=o}return p},more:function(){return this.peek()!==null},applies:function(g){var f=this.peek();return(f!==null&&g(f))},nextWhile:function(g){var f;while((f=this.peek())!==null&&g(f)){this.next()}},matches:function(g){var f=this.peek();return(f!==null&&g.test(f))},nextWhileMatches:function(g){var f;while((f=this.peek())!==null&&g.test(f)){this.next()}},equals:function(f){return f===this.peek()},endOfLine:function(){var f=this.peek();return f==null||f=="\n"}}};var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);var webkit=/AppleWebKit/.test(navigator.userAgent);var safari=/Apple Computers, Inc/.test(navigator.vendor);var gecko=/gecko\/(\d{8})/i.test(navigator.userAgent);function makeWhiteSpace(c){var b=[],a=true;for(;c>0;c--){b.push((a||c==1)?nbsp:" ");a=!a}return b.join("")}function fixSpaces(a){if(a.charAt(0)==" "){a=nbsp+a.slice(1)}return a.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(b){return makeWhiteSpace(b.length)})}function cleanText(a){return a.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(b,c){var d=b;if(b.nodeType==3){d=b.nodeValue}else{b=c.createTextNode(d)}var a=c.createElement("SPAN");a.isPart=true;a.appendChild(b);a.currentText=d;return a}var webkitLastLineHack=webkit?function(a){var b=a.lastChild;if(!b||!b.isPart||b.textContent!="\u200b"){a.appendChild(makePartSpan("\u200b",a.ownerDocument))}}:function(){};var Editor=(function(){var g={P:true,DIV:true,LI:true};function b(l){var m=makeWhiteSpace(indentUnit);return map(l.replace(/\t/g,m).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function d(n,m){var p=n.ownerDocument;var l=[];var q=true;function o(r,s){if(r.nodeType==3){var t=r.nodeValue=fixSpaces(r.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "));if(t.length){q=false}l.push(r)}else{if(isBR(r)&&r.childNodes.length==0){q=true;l.push(r)}else{forEach(r.childNodes,o);if(!q&&g.hasOwnProperty(r.nodeName.toUpperCase())){q=true;if(!m||!s){l.push(p.createElement("BR"))}}}}}o(n,true);return l}function e(l){function q(z,A){n=A;return z}function t(A,z,B){return function(){return A(z,B)}}function v(){n=v;throw StopIteration}var n=t(w,l,v);var m=l.ownerDocument;var o=[];function s(B){var A=B.parentNode;var z=B.nextSibling;return function(C){A.insertBefore(C,z)}}var x=null;var u=true;function p(z){var A="\n";if(z.nodeType==3){select.snapshotChanged();z=makePartSpan(z,m);A=z.currentText;u=false}else{if(u&&window.opera){x(makePartSpan("",m))}u=true}z.dirty=true;o.push(z);x(z);return A}function r(B,C,z){var A=[];forEach(d(B,z),function(D){A.push(p(D))});return q(A.join(""),C)}function y(z){if(z.isPart&&z.childNodes.length==1&&z.firstChild.nodeType==3){z.currentText=z.firstChild.nodeValue;return !/[\n\t\r]/.test(z.currentText)}return false}function w(A,B){if(A.nextSibling){B=t(w,A.nextSibling,B)}if(y(A)){o.push(A);u=false;return q(A.currentText,B)}else{if(isBR(A)){if(u&&window.opera){A.parentNode.insertBefore(makePartSpan("",m),A)}o.push(A);u=true;return q("\n",B)}else{var z=!A.nextSibling;x=s(A);removeElement(A);return r(A,B,z)}}}return{next:function(){return n()},nodes:o}}function h(l){return isBR(l)?1:l.currentText.length}function j(l){while(l&&!isBR(l)){l=l.previousSibling}return l}function k(m,l){if(!m){m=l.firstChild}else{if(isBR(m)){m=m.nextSibling}}while(m&&!isBR(m)){m=m.nextSibling}return m}function c(){return new Date().getTime()}function i(p,n,m,o){this.editor=p;this.caseFold=o;if(o){n=n.toLowerCase()}this.history=p.history;this.history.commit();this.atOccurrence=false;this.fallbackSize=15;var r;if(m&&(r=select.cursorPos(this.editor.container))){this.line=r.node;this.offset=r.offset}else{this.line=null;this.offset=0}this.valid=!!n;var q=n.split("\n"),l=this;this.matches=(q.length==1)?function(){var s=cleanText(l.history.textAfter(l.line).slice(l.offset));var t=(l.caseFold?s.toLowerCase():s).indexOf(n);if(t>-1){return{from:{node:l.line,offset:l.offset+t},to:{node:l.line,offset:l.offset+t+n.length}}}}:function(){var x=cleanText(l.history.textAfter(l.line).slice(l.offset));var w=(l.caseFold?x.toLowerCase():x).lastIndexOf(q[0]);if(w==-1||w!=x.length-q[0].length){return false}var s=l.offset+w;var v=l.history.nodeAfter(l.line);for(var y=1;y<q.length-1;y++){var u=cleanText(l.history.textAfter(v));if((l.caseFold?u.toLowerCase():u)!=q[y]){return false}v=l.history.nodeAfter(v)}var t=cleanText(l.history.textAfter(v));if((l.caseFold?t.toLowerCase():t).indexOf(q[q.length-1])!=0){return false}return{from:{node:l.line,offset:s},to:{node:v,offset:q[q.length-1].length}}}}i.prototype={findNext:function(){if(!this.valid){return false}this.atOccurrence=false;var l=this;if(this.line&&!this.line.parentNode){this.line=null;this.offset=0}function n(o){if(l.history.textAfter(o.node).length>o.offset){l.line=o.node;l.offset=o.offset+1}else{l.line=l.history.nodeAfter(o.node);l.offset=0}}while(true){var m=this.matches();if(m){this.atOccurrence=m;n(m.from);return true}this.line=this.history.nodeAfter(this.line);this.offset=0;if(!this.line){this.valid=false;return false}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.atOccurrence.from,this.atOccurrence.to);select.scrollToCursor(this.editor.container)}},replace:function(m){if(this.atOccurrence){var l=this.editor.replaceRange(this.atOccurrence.from,this.atOccurrence.to,m);this.line=l.node;this.offset=l.offset;this.atOccurrence=false}}};function f(o){this.options=o;window.indentUnit=o.indentUnit;this.parent=parent;this.doc=document;var l=this.container=this.doc.body;this.win=window;this.history=new History(l,o.undoDepth,o.undoDelay,this);var n=this;if(!f.Parser){throw"No parser loaded."}if(o.parserConfig&&f.Parser.configure){f.Parser.configure(o.parserConfig)}if(!o.readOnly){select.setCursorPos(l,{node:null,offset:0})}this.dirty=[];this.importCode(o.content||"");this.history.onChange=o.onChange;if(!o.readOnly){if(o.continuousScanning!==false){this.scanner=this.documentScanner(o.passTime);this.delayScanning()}function p(){if(document.body.contentEditable!=undefined&&internetExplorer){document.body.contentEditable="true"}else{document.designMode="on"}document.documentElement.style.borderWidth="0";if(!o.textWrapping){l.style.whiteSpace="nowrap"}}try{p()}catch(r){var m=addEventHandler(document,"focus",function(){m();p()},true)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));function q(){n.cursorActivity(false)}addEventHandler(document.body,"mouseup",q);addEventHandler(document.body,"cut",q);if(gecko){addEventHandler(this.win,"pagehide",function(){n.unloaded=true})}addEventHandler(document.body,"paste",function(s){q();var u=null;try{var v=s.clipboardData||window.clipboardData;if(v){u=v.getData("Text")}}catch(t){}if(u!==null){s.stop();n.replaceSelection(u);select.scrollToCursor(n.container)}});if(this.options.autoMatchParens){addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}else{if(!o.textWrapping){l.style.whiteSpace="nowrap"}}}function a(l){return(l>=16&&l<=18)||(l>=33&&l<=40)}f.prototype={importCode:function(l){this.history.push(null,null,b(l));this.history.reset()},getCode:function(){if(!this.container.firstChild){return""}var l=[];select.markSelection(this.win);forEach(e(this.container.firstChild),method(l,"push"));webkitLastLineHack(this.container);select.selectMarked();return cleanText(l.join(""))},checkLine:function(l){if(l===false||!(l==null||l.parentNode==this.container)){throw parent.CodeMirror.InvalidLineHandle}},cursorPosition:function(m){if(m==null){m=true}var l=select.cursorPos(this.container,m);if(l){return{line:l.node,character:l.offset}}else{return{line:null,character:0}}},firstLine:function(){return null},lastLine:function(){if(this.container.lastChild){return j(this.container.lastChild)}else{return null}},nextLine:function(m){this.checkLine(m);var l=k(m,this.container);return l||false},prevLine:function(l){this.checkLine(l);if(l==null){return false}return j(l.previousSibling)},visibleLineCount:function(){var l=this.container.firstChild;while(l&&isBR(l)){l=l.nextSibling}if(!l){return false}var m=(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight);return Math.floor(m/l.offsetHeight)},selectLines:function(p,l,o,n){this.checkLine(p);var q={node:p,offset:l},m=null;if(n!==undefined){this.checkLine(o);m={node:o,offset:n}}select.setCursorPos(this.container,q,m);select.scrollToCursor(this.container)},lineContent:function(l){var m=[];for(l=l?l.nextSibling:this.container.firstChild;l&&!isBR(l);l=l.nextSibling){m.push(nodeText(l))}return cleanText(m.join(""))},setLineContent:function(l,m){this.history.commit();this.replaceRange({node:l,offset:0},{node:l,offset:this.history.textAfter(l).length},m);this.addDirtyNode(l);this.scheduleHighlight()},removeLine:function(l){var n=l?l.nextSibling:this.container.firstChild;while(n){var m=n.nextSibling;removeElement(n);if(isBR(n)){break}n=m}this.addDirtyNode(l);this.scheduleHighlight()},insertIntoLine:function(s,m,n){var o=null;if(m=="end"){o=k(s,this.container)}else{for(var q=s?s.nextSibling:this.container.firstChild;q;q=q.nextSibling){if(m==0){o=q;break}var r=nodeText(q);if(r.length>m){o=q.nextSibling;n=r.slice(0,m)+n+r.slice(m);removeElement(q);break}m-=r.length}}var t=b(n),p=this.container.ownerDocument;for(var l=0;l<t.length;l++){if(l>0){this.container.insertBefore(p.createElement("BR"),o)}this.container.insertBefore(makePartSpan(t[l],p),o)}this.addDirtyNode(s);this.scheduleHighlight()},selectedText:function(){var m=this.history;m.commit();var p=select.cursorPos(this.container,true),l=select.cursorPos(this.container,false);if(!p||!l){return""}if(p.node==l.node){return m.textAfter(p.node).slice(p.offset,l.offset)}var n=[m.textAfter(p.node).slice(p.offset)];for(var o=m.nodeAfter(p.node);o!=l.node;o=m.nodeAfter(o)){n.push(m.textAfter(o))}n.push(m.textAfter(l.node).slice(0,l.offset));return cleanText(n.join("\n"))},replaceSelection:function(m){this.history.commit();var n=select.cursorPos(this.container,true),l=select.cursorPos(this.container,false);if(!n||!l){return}l=this.replaceRange(n,l,m);select.setCursorPos(this.container,l);webkitLastLineHack(this.container)},reroutePasteEvent:function(){if(this.capturingPaste||window.opera){return}this.capturingPaste=true;var m=window.frameElement.CodeMirror.textareaHack;parent.focus();m.value="";m.focus();var l=this;this.parent.setTimeout(function(){l.capturingPaste=false;l.win.focus();if(l.selectionSnapshot){l.win.select.setBookmark(l.container,l.selectionSnapshot)}var n=m.value;if(n){l.replaceSelection(n);select.scrollToCursor(l.container)}},10)},replaceRange:function(q,p,o){var n=b(o);n[0]=this.history.textAfter(q.node).slice(0,q.offset)+n[0];var m=n[n.length-1];n[n.length-1]=m+this.history.textAfter(p.node).slice(p.offset);var l=this.history.nodeAfter(p.node);this.history.push(q.node,l,n);return{node:this.history.nodeBefore(l),offset:m.length}},getSearchCursor:function(m,l,n){return new i(this,m,l,n)},reindent:function(){if(this.container.firstChild){this.indentRegion(null,this.container.lastChild)}},reindentSelection:function(m){if(!select.somethingSelected(this.win)){this.indentAtCursor(m)}else{var n=select.selectionTopNode(this.container,true),l=select.selectionTopNode(this.container,false);if(n===false||l===false){return}this.indentRegion(n,l,m)}},grabKeys:function(l,m){this.frozen=l;this.keyFilter=m},ungrabKeys:function(){this.frozen="leave";this.keyFilter=null},setParser:function(l){f.Parser=window[l];if(this.container.firstChild){forEach(this.container.childNodes,function(m){if(m.nodeType!=3){m.dirty=true}});this.addDirtyNode(this.firstChild);this.scheduleHighlight()}},keyDown:function(n){if(this.frozen=="leave"){this.frozen=null}if(this.frozen&&(!this.keyFilter||this.keyFilter(n.keyCode,n))){n.stop();this.frozen(n);return}var m=n.keyCode;this.delayScanning();if(this.options.autoMatchParens){this.scheduleParenHighlight()}if(m==13){if(n.ctrlKey&&!n.altKey){this.reparseBuffer()}else{select.insertNewlineAtCursor(this.win);this.indentAtCursor();select.scrollToCursor(this.container)}n.stop()}else{if(m==9&&this.options.tabMode!="default"&&!n.ctrlKey){this.handleTab(!n.shiftKey);n.stop()}else{if(m==32&&n.shiftKey&&this.options.tabMode=="default"){this.handleTab(true);n.stop()}else{if(m==36&&!n.shiftKey&&!n.ctrlKey){if(this.home()){n.stop()}}else{if(m==35&&!n.shiftKey&&!n.ctrlKey){if(this.end()){n.stop()}}else{if(m==33&&!n.shiftKey&&!n.ctrlKey&&!gecko){if(this.pageUp()){n.stop()}}else{if(m==34&&!n.shiftKey&&!n.ctrlKey&&!gecko){if(this.pageDown()){n.stop()}}else{if((m==219||m==221)&&n.ctrlKey&&!n.altKey){this.highlightParens(n.shiftKey,true);n.stop()}else{if(n.metaKey&&!n.shiftKey&&(m==37||m==39)){var o=select.selectionTopNode(this.container);if(o===false||!this.container.firstChild){return}if(m==37){select.focusAfterNode(j(o),this.container)}else{var l=k(o,this.container);select.focusAfterNode(l?l.previousSibling:this.container.lastChild,this.container)}n.stop()}else{if((n.ctrlKey||n.metaKey)&&!n.altKey){if((n.shiftKey&&m==90)||m==89){select.scrollToNode(this.history.redo());n.stop()}else{if(m==90||(safari&&m==8)){select.scrollToNode(this.history.undo());n.stop()}else{if(m==83&&this.options.saveFunction){this.options.saveFunction();n.stop()}else{if(internetExplorer&&m==86){this.reroutePasteEvent()}}}}}}}}}}}}}}},keyPress:function(n){var l=f.Parser.electricChars,m=this;if((this.frozen&&(!this.keyFilter||this.keyFilter(n.keyCode,n)))||n.code==13||(n.code==9&&this.options.tabMode!="default")||(n.keyCode==32&&n.shiftKey&&this.options.tabMode=="default")){n.stop()}else{if(l&&l.indexOf(n.character)!=-1){this.parent.setTimeout(function(){m.indentAtCursor(null)},0)}else{if((n.character=="v"||n.character=="V")&&(n.ctrlKey||n.metaKey)&&!n.altKey){this.reroutePasteEvent()}}}},keyUp:function(l){this.cursorActivity(a(l.keyCode))},indentLineAfter:function(l,r){var s=l?l.nextSibling:this.container.firstChild;if(s&&!hasClass(s,"whitespace")){s=null}var p=s?s.nextSibling:(l?l.nextSibling:this.container.firstChild);var o=(l&&p&&p.currentText)?p.currentText:"";var m=0,t=s?s.currentText.length:0;if(r!=null&&this.options.tabMode=="shift"){m=r?t+indentUnit:Math.max(0,t-indentUnit)}else{if(l){m=l.indentation(o,t,r)}else{if(f.Parser.firstIndentation){m=f.Parser.firstIndentation(o,t,r)}}}var n=m-t;if(n<0){if(m==0){if(p){select.snapshotMove(s.firstChild,p.firstChild,0)}removeElement(s);s=null}else{select.snapshotMove(s.firstChild,s.firstChild,n,true);s.currentText=makeWhiteSpace(m);s.firstChild.nodeValue=s.currentText}}else{if(n>0){if(s){s.currentText=makeWhiteSpace(m);s.firstChild.nodeValue=s.currentText}else{s=makePartSpan(makeWhiteSpace(m),this.doc);s.className="whitespace";if(l){insertAfter(s,l)}else{this.container.insertBefore(s,this.container.firstChild)}}var q=p&&(p.firstChild||p);select.snapshotMove(q,s.firstChild,m,false,true)}}if(n!=0){this.addDirtyNode(l)}},highlightAtCursor:function(){var m=select.selectionTopNode(this.container,true);var l=select.selectionTopNode(this.container,false);if(m===false||l===false){return false}select.markSelection(this.win);if(this.highlight(m,k(l,this.container),true,20)===false){return false}select.selectMarked();return true},handleTab:function(l){if(this.options.tabMode=="spaces"){select.insertTabAtCursor(this.win)}else{this.reindentSelection(l)}},home:function(){var m=select.selectionTopNode(this.container,true),n=m;if(m===false||!(!m||m.isPart||isBR(m))||!this.container.firstChild){return false}while(m&&!isBR(m)){m=m.previousSibling}var l=m?m.nextSibling:this.container.firstChild;if(l&&l!=n&&l.isPart&&hasClass(l,"whitespace")){select.focusAfterNode(l,this.container)}else{select.focusAfterNode(m,this.container)}select.scrollToCursor(this.container);return true},end:function(){var l=select.selectionTopNode(this.container,true);if(l===false){return false}l=k(l,this.container);if(!l){return false}select.focusAfterNode(l.previousSibling,this.container);select.scrollToCursor(this.container);return true},pageUp:function(){var l=this.cursorPosition().line,n=this.visibleLineCount();if(l===false||n===false){return false}n-=2;for(var m=0;m<n;m++){l=this.prevLine(l);if(l===false){break}}if(m==0){return false}select.setCursorPos(this.container,{node:l,offset:0});select.scrollToCursor(this.container);return true},pageDown:function(){var l=this.cursorPosition().line,o=this.visibleLineCount();if(l===false||o===false){return false}o-=2;for(var m=0;m<o;m++){var n=this.nextLine(l);if(n===false){break}l=n}if(m==0){return false}select.setCursorPos(this.container,{node:l,offset:0});select.scrollToCursor(this.container);return true},scheduleParenHighlight:function(){if(this.parenEvent){this.parent.clearTimeout(this.parenEvent)}var l=this;this.parenEvent=this.parent.setTimeout(function(){l.highlightParens()},300)},highlightParens:function(y,m){var w=this;function o(A,z){if(!A){return}if(w.options.markParen){w.options.markParen(A,z)}else{A.style.fontWeight="bold";A.style.color=z?"#8F8":"#F88"}}function t(z){if(!z){return}if(w.options.unmarkParen){w.options.unmarkParen(z)}else{z.style.fontWeight="";z.style.color=""}}if(!m&&w.highlighted){t(w.highlighted[0]);t(w.highlighted[1])}if(!window.select){return}if(this.parenEvent){this.parent.clearTimeout(this.parenEvent)}this.parenEvent=null;function u(A){if(A.currentText){var z=A.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return z&&z[1]}}function q(z){return/[\(\[\{]/.test(z)}var l,v=select.selectionTopNode(this.container,true);if(!v||!this.highlightAtCursor()){return}v=select.selectionTopNode(this.container,true);if(!(v&&((l=u(v))||(v=v.nextSibling)&&(l=u(v))))){return}var s=v.className,n=q(l),p=matching[l];function r(){var z=[],B,A=true;for(var C=v;C;C=n?C.nextSibling:C.previousSibling){if(C.className==s&&isSpan(C)&&(B=u(C))){if(q(B)==n){z.push(B)}else{if(!z.length){A=false}else{if(z.pop()!=matching[B]){A=false}}}if(!z.length){break}}else{if(C.dirty||!isSpan(C)&&!isBR(C)){return{node:C,status:"dirty"}}}}return{node:C,status:C&&A}}while(true){var x=r();if(x.status=="dirty"){this.highlight(x.node,k(x.node));x.node.dirty=false;continue}else{o(v,x.status);o(x.node,x.status);if(m){w.parent.setTimeout(function(){t(v);t(x.node)},500)}else{w.highlighted=[v,x.node]}if(y&&x.node){select.focusAfterNode(x.node.previousSibling,this.container)}break}}},indentAtCursor:function(l){if(!this.container.firstChild){return}if(!this.highlightAtCursor()){return}var m=select.selectionTopNode(this.container,false);if(m===false){return}select.markSelection(this.win);this.indentLineAfter(j(m),l);select.selectMarked()},indentRegion:function(q,l,p){var o=(q=j(q)),n=q&&j(q.previousSibling);if(!isBR(l)){l=k(l,this.container)}this.addDirtyNode(q);do{var m=k(o,this.container);if(o){this.highlight(n,m,true)}this.indentLineAfter(o,p);n=o;o=m}while(o!=l);select.setCursorPos(this.container,{node:q,offset:0},{node:l,offset:0})},cursorActivity:function(l){if(this.unloaded){this.win.document.designMode="off";this.win.document.designMode="on";this.unloaded=false}if(internetExplorer){this.container.createTextRange().execCommand("unlink");this.selectionSnapshot=select.getBookmark(this.container)}var m=this.options.cursorActivity;if(!l||m){var n=select.selectionTopNode(this.container,false);if(n===false||!this.container.firstChild){return}n=n||this.container.firstChild;if(m){m(n)}if(!l){this.scheduleHighlight();this.addDirtyNode(n)}}},reparseBuffer:function(){forEach(this.container.childNodes,function(l){l.dirty=true});if(this.container.firstChild){this.addDirtyNode(this.container.firstChild)}},addDirtyNode:function(m){m=m||this.container.firstChild;if(!m){return}for(var l=0;l<this.dirty.length;l++){if(this.dirty[l]==m){return}}if(m.nodeType!=3){m.dirty=true}this.dirty.push(m)},allClean:function(){return !this.dirty.length},scheduleHighlight:function(){var l=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){l.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var l=this.dirty.pop();try{while(l&&l.parentNode!=this.container){l=l.parentNode}if(l&&(l.dirty||l.nodeType==3)){return l}}catch(m){}}return null},highlightDirty:function(n){if(!window.select){return false}if(!this.options.readOnly){select.markSelection(this.win)}var o,m=n?null:c()+this.options.passTime;while((c()<m||n)&&(o=this.getDirtyNode())){var l=this.highlight(o,m);if(l&&l.node&&l.dirty){this.addDirtyNode(l.node)}}if(!this.options.readOnly){select.selectMarked()}if(o){this.scheduleHighlight()}return this.dirty.length==0},documentScanner:function(l){var m=this,n=null;return function(){if(!window.select){return}if(n&&n.parentNode!=m.container){n=null}select.markSelection(m.win);var o=m.highlight(n,c()+l,true);select.selectMarked();var p=o?(o.node&&o.node.nextSibling):null;n=(n==p)?null:p;m.delayScanning()}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(A,E,C,w){var u=this.container,v=this,q=this.options.activeTokens;var o=(typeof E=="number"?E:null);if(!u.firstChild){return false}while(A&&(!A.parserFromHere||A.dirty)){if(w!=null&&isBR(A)&&(--w)<0){return false}A=A.previousSibling}if(A&&!A.nextSibling){return false}function r(G,F){return !F.reduced&&F.currentText==G.value&&F.className==G.style}function m(F,G){F.currentText=F.currentText.substring(G);F.reduced=true}function s(G){var F=makePartSpan(G.value,v.doc);F.className=G.style;return F}function B(G){if(G){var F=G.oldNextSibling;if(z||F===undefined||G.nextSibling!=F){v.history.touch(G)}G.oldNextSibling=G.nextSibling}else{var F=v.container.oldFirstChild;if(z||F===undefined||v.container.firstChild!=F){v.history.touch(null)}v.container.oldFirstChild=v.container.firstChild}}var n=e(A?A.nextSibling:u.firstChild),p=stringStream(n),t=A?A.parserFromHere(p):f.Parser.make(p);function x(F){return(F.previousSibling==null||isBR(F.previousSibling))&&(F.nextSibling==null||isBR(F.nextSibling))}var y={current:null,get:function(){if(!this.current){this.current=n.nodes.shift()}return this.current},next:function(){this.current=null},remove:function(){u.removeChild(this.get());this.current=null},getNonEmpty:function(){var G=this.get();while(G&&isSpan(G)&&G.currentText==""){if(window.opera&&x(G)){this.next();G=this.get()}else{var F=G;this.remove();G=this.get();select.snapshotMove(F.firstChild,G&&(G.firstChild||G),0)}}return G}};var z=false,D=true,l=0;forEach(t,function(H){var G=y.getNonEmpty();if(H.value=="\n"){if(!isBR(G)){throw"Parser out of sync. Expected BR."}if(G.dirty||!G.indentation){z=true}B(A);A=G;G.parserFromHere=t.copy();G.indentation=H.indentation;G.dirty=false;if(o==null&&G==E){throw StopIteration}if((o!=null&&c()>=o)||(!z&&!D&&l>1&&!C)){throw StopIteration}D=z;z=false;l=0;y.next()}else{if(!isSpan(G)){throw"Parser out of sync. Expected SPAN."}if(G.dirty){z=true}l++;if(r(H,G)){G.dirty=false;y.next()}else{z=true;var F=s(H);u.insertBefore(F,G);if(q){q(F,H,v)}var K=H.value.length;var J=0;while(K>0){G=y.get();var I=G.currentText.length;select.snapshotReplaceNode(G.firstChild,F.firstChild,K,J);if(I>K){m(G,K);K=0}else{K-=I;J+=I;y.remove()}}}}});B(A);webkitLastLineHack(this.container);return{node:y.getNonEmpty(),dirty:z}}};return f})();addEventHandler(window,"load",function(){var a=window.frameElement.CodeMirror;var b=a.editor=new Editor(a.options);this.parent.setTimeout(method(a,"init"),0)});